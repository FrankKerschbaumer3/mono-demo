version: 0.2

# ENV Vars to set in CodeBuild
#
# AWS_REGION      - AWS Default Region     (e.g. us-east-1)
# IMAGE_REPO_NAME - Name of the image repo (e.g. my-app)
# IMAGE_TAG       - Tag for the image      (e.g. latest)
# AWS_ACCOUNT_ID  - Remote AWS account id  (e.g. 555555555555)

phases:
    install:
        commands:
            - echo "Installing SBT"
            - echo "deb http://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
            - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2EE0EA64E40A89B84B2DF73499E82A75642AC823
            - sudo apt-get update
            - sudo apt-get install sbt
            - git log -1
            - printenv
            - echo $CODEBUILD_BUILD_ID
    build:
        commands:
            - cd ./hello-service
            - echo "Building image"
            - sbt -Dtests_only docker:stage
            - docker build -t hello-tests -f ./target/docker/stage/Dockerfile
            - docker run --rm hello-tests